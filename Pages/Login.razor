@page "/Login"
@inject IJSRuntime JS
@using Lottery.Services
@inject UserState UserState
@inject NavigationManager Nav

<div style="text-align: center;">
    <h3>üîê Login / Register</h3>
</div>

<div class="d-flex justify-content-center">
    <div class="card p-4" style="max-width:400px; width:100%;">
        <div class="mb-3">
            @if (!UserState.IsLoggedIn)
            {
                <label>Email</label>
                <input @bind="Email" class="form-control" placeholder="Enter your email" />
            }
        </div>

        <div class="mb-3">
            @if (!UserState.IsLoggedIn)
            {
                <label>Password</label>
                <input type="password" @bind="Password" class="form-control" placeholder="Enter password" />
            }
        </div>

        <div class="d-flex gap-2">
            @if (!UserState.IsLoggedIn)
            {
                <button class="btn btn-primary w-50" @onclick="DoLogin">Login</button>
                <button class="btn btn-success w-50" @onclick="RegisterPopup">Register</button>
            }
        </div>

        @if (UserState.IsLoggedIn)
        {
        <div class="text-center mb-3">
             <p class="mb-1">üëã Welcome</p> @* <p is ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ *@
            <strong>@UserState.Email</strong>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-danger w-100 mb-3" @onclick="Logout">Logout</button>
        </div>
        }

        @if (!string.IsNullOrEmpty(Message))
        {
            <p class="mt-3 text-info">@Message</p>
        }
    </div>
</div>

@code {
    private string Email = "";
    private string Password = "";
    private string Message = "";

    protected override void OnInitialized()
    {
        UserState.OnChange += StateHasChanged; // üëà ‡∏ö‡∏≠‡∏Å component ‡πÉ‡∏´‡πâ refresh ‡πÄ‡∏°‡∏∑‡πà‡∏≠ state ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    }

    private async Task RegisterPopup()
    {
        await JS.InvokeVoidAsync("registerPopup");
    }
    private async Task DoLogin()
    {
        var result = await JS.InvokeAsync<string>("loginUser", Email, Password);
        Message = result != null ? $"Welcome: {result}" : "Login failed";

        if (result != null)
        {
            UserState.Email = Email;
            UserState.IsLoggedIn = true;
            UserState.NotifyStateChanged(); // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ Layout ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô

            // ‡∏´‡∏•‡∏±‡∏á login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            Nav.NavigateTo("/");
        }
    }
    private async Task Logout()
    {
        await JS.InvokeVoidAsync("logoutUser");
        Message = "Logged out";
        UserState.IsLoggedIn = false;
        UserState.Email = string.Empty;
        UserState.NotifyStateChanged();
    }
}